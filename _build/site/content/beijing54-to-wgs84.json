{"version":2,"kind":"Notebook","sha256":"9744902e8e0e8e7c752f31f2f2153314f780528165a06b788ddc9af48a18614d","slug":"beijing54-to-wgs84","location":"/geocode/beijing54_to_wgs84.ipynb","dependencies":[],"frontmatter":{"title":"Beijing 1954 (TIFF) ➜ WGS 84 (EPSG:4326) — Raster Re-projection","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3","language":"python"},"numbering":{"title":{"offset":1}},"exports":[{"format":"ipynb","filename":"beijing54_to_wgs84.ipynb","url":"/beijing54_to_wgs84-ca55633da1eb884d123f11ab84a8b043.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Convert a georeferenced raster from ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"h9IePM40jq"},{"type":"strong","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Beijing 1954","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"Irga9sGHel"}],"key":"ECwww0ocNW"},{"type":"text","value":" (aka ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"F0vn91KkPG"},{"type":"emphasis","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Beijing 54","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"ubURXNrHBP"}],"key":"tRCqWieXdc"},{"type":"text","value":") to ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"B26eEjE5Na"},{"type":"strong","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"WGS 84","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"CwsLgYw25g"}],"key":"p4UTYBcrIJ"},{"type":"text","value":" using a table of ground-control points.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"m0UqCH4Wv3"}],"key":"zo7wTjcmeh"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"strong","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Workflow","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"cZ4rLEgx7N"}],"key":"JsSPw6sE2C"}],"key":"v9mb7cZ2W1"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Load control-point table (","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"YbFHRxPZmp"},{"type":"inlineCode","value":"54_to_84.csv","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"u2PAGYTjRd"},{"type":"text","value":").","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Ao75edTXun"}],"key":"T8vRqFs4eh"}],"key":"NTzYSf7t5R"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Attach the GCPs (Beijing 54 ➜ WGS 84) to the original TIFF.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"o88ta6eKOb"}],"key":"g3uR5a3z5F"}],"key":"UbOltLT5Kx"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Call ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"E49LMIUfuc"},{"type":"strong","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"GDAL Warp","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"qfD6j94KCI"}],"key":"ft57eRitMz"},{"type":"text","value":" (","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"dRW2d1Q7Kq"},{"type":"inlineCode","value":"gdal.Warp","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"uHWfyzc7Ub"},{"type":"text","value":") with a Thin-Plate Spline (TPS) or 1st-order polynomial transform.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"DSqbDMT62r"}],"key":"XR5IHwKvJO"}],"key":"YUK2QEpr04"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Save the re-projected raster as GeoTIFF in WGS 84.","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"RaTGPsEAue"}],"key":"o4nRmjuEi7"}],"key":"NYttUM24DF"}],"key":"iZsQ0Jqk8s"}],"key":"PFJCPVSWXO"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Requirements","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Lnzjl88uWq"}],"identifier":"requirements","label":"Requirements","html_id":"requirements","implicit":true,"key":"sudCSu5m7c"},{"type":"code","lang":"bash","value":"conda install -c conda-forge gdal rasterio pyproj pandas","position":{"start":{"line":2,"column":1},"end":{"line":4,"column":1}},"key":"gFtXtbpZ5Q"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"GDAL ≥ 3.1 is recommended so that ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"ohnRCuZ0xz"},{"type":"inlineCode","value":"gdal.Warp","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"IhMRwymw7a"},{"type":"text","value":" can use the ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"el6KkdxHLF"},{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"inlineCode","value":"tps=True","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"INGFvln3OW"}],"key":"bIc7TaQf3A"},{"type":"text","value":" option.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"ITaT1Rjg9T"}],"key":"hGvN6axgZr"}],"key":"NNAZG7Lbyk"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nfrom osgeo import gdal, osr\nimport pandas as pd\nfrom typing import List\n","key":"DneNCMVeTj"},{"type":"output","id":"P0TYOvHV-Ur5kU3oVLSph","data":[],"key":"VlC2G4HRQx"}],"key":"aX333GMsZ3"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# ---- User inputs -------------------------------------------------------\ninput_tiff   = \"beijing54.tif\"         # Source raster (Beijing 54)\ngcps_csv     = \"54_to_84.csv\"          # Control-point table (CSV)\noutput_tiff  = \"beijing54_to_wgs84.tif\"\n\n# Transform method:  'tps' (thin-plate spline) or polynomial order (int)\ntransform_method = \"tps\"   # choose \"tps\" or 1/2/3 for polynomial order\n","key":"tSsGcMm3H3"},{"type":"output","id":"Zzu9N7URq4U9NRCfqkLra","data":[],"key":"pT0UgmiHiJ"}],"key":"Ao2kDZeviT"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# The CSV must contain:\n#   x54, y54  ▶ coordinates in Beijing 54 (same units as the raster)\n#   lon84, lat84 ▶ WGS 84 geographic coordinates (decimal degrees)\ngdf = pd.read_csv(gcps_csv)\n\n# Open source raster\nsrc_ds = gdal.Open(input_tiff, gdal.GA_ReadOnly)\nif src_ds is None:\n    raise FileNotFoundError(f\"Cannot open {input_tiff}\")\n\ngt = src_ds.GetGeoTransform()\ninv_gt = gdal.InvGeoTransform(gt)\n\n# Build GCP list\ngdal_gcps: List[gdal.GCP] = []\nfor _, row in gdf.iterrows():\n    x54, y54 = float(row['x54']), float(row['y54'])\n    lon84, lat84 = float(row['lon84']), float(row['lat84'])\n    # Convert world → pixel\n    px, py = gdal.ApplyGeoTransform(inv_gt, x54, y54)\n    gcp = gdal.GCP(lon84, lat84, 0, px, py)  # (lon, lat, z, pixel, line)\n    gdal_gcps.append(gcp)\n\nprint(f\"Loaded {len(gdal_gcps)} control points.\")\n","key":"ZaY59NpOO2"},{"type":"output","id":"Z5fohhsqNAU_xh_JOBFmS","data":[],"key":"lD40GnQOby"}],"key":"Msb2Ym0EiF"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Create an in-memory VRT copy with GCPs\nvrt_path = \"/vsimem/tmp_with_gcps.vrt\"\ngdal.Translate(\n    vrt_path,\n    src_ds,\n    GCPs=gdal_gcps,\n    outputSRS=\"EPSG:4326\"  # Target GCP spatial ref (WGS 84)\n)\nsrc_ds = None  # close\n","key":"uXehoQOPS8"},{"type":"output","id":"vd2bXSf91dnAXiGatkqm2","data":[],"key":"TUKnheqDip"}],"key":"RvL6uDq3Tg"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"warp_kwargs = dict(\n    dstSRS=\"EPSG:4326\",\n    format=\"GTiff\",\n    xRes=0.0002695,   # ≈ 30 m at the equator — adjust as needed\n    yRes=0.0002695,\n    resampleAlg=\"bilinear\",\n    multithread=True\n)\n\nif transform_method == \"tps\":\n    warp_kwargs[\"tps\"] = True\nelse:\n    warp_kwargs[\"polynomialOrder\"] = int(transform_method)\n\ngdal.Warp(\n    destNameOrDestDS=output_tiff,\n    srcDSOrSrcDSTab=vrt_path,\n    **warp_kwargs\n)\n\nprint(f\"Warp complete ➜ {output_tiff}\")\n","key":"BO1hVvjDN2"},{"type":"output","id":"EB4vz4zRexPx282HqBsCO","data":[],"key":"FhzCsRNrsd"}],"key":"MozZIqhW1w"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds = gdal.Open(output_tiff)\nprint(\"Target CRS:\", ds.GetSpatialRef().ExportToWkt().split(',')[0])\nprint(\"Raster size :\", ds.RasterXSize, \"×\", ds.RasterYSize)\nprint(\"GeoTransform:\", ds.GetGeoTransform())\nds = None\n","key":"WX098gahXj"},{"type":"output","id":"Zm7XlbyldkCXxL6PhdcUu","data":[],"key":"sXPxvEcm5z"}],"key":"YHj0RHCosD"},{"type":"block","kind":"notebook-content","children":[{"type":"thematicBreak","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LukRWJYMlt"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"strong","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Tips","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"sFgurL5EQT"}],"key":"FtGDc5JcNr"}],"key":"YiIjsg2sfG"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":3,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"If you prefer to use a 1st-order polynomial instead of TPS, set ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"IlLDtRokJr"},{"type":"inlineCode","value":"transform_method = 1","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ApfPskLmEu"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"wnYur0zi7r"}],"key":"KHJyCSHYit"}],"key":"NZJaKGBoZM"},{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Increase the number of well-distributed control points for higher accuracy.","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"J5258GoQ3K"}],"key":"rIH0GPiONq"}],"key":"OgE1LoDpim"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"xRes","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"bCm4UI6fyu"},{"type":"text","value":"/","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"PJ1uwkFmNH"},{"type":"inlineCode","value":"yRes","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"sxr9xvc0B4"},{"type":"text","value":" control the output resolution. Adjust to suit your data.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"QW5L91kmdT"}],"key":"f6hUnw8BIw"}],"key":"ZW8jJ84yL8"}],"key":"tp5Dttqg1x"}],"key":"ANuttDmCYG"}],"key":"wdLOoyAyy2"},"references":{"cite":{"order":[],"data":{}}}}