{"version":2,"kind":"Notebook","sha256":"9744902e8e0e8e7c752f31f2f2153314f780528165a06b788ddc9af48a18614d","slug":"beijing54-to-wgs84","location":"/geoprocessing_code/geocode/beijing54_to_wgs84.ipynb","dependencies":[],"frontmatter":{"title":"Beijing 1954 (TIFF) ➜ WGS 84 (EPSG:4326) — Raster Re-projection","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3","language":"python"},"numbering":{"title":{"offset":2}},"exports":[{"format":"ipynb","filename":"beijing54_to_wgs84.ipynb","url":"/beijing54_to_wgs84-9fff8be8073378d3ad9581628868bbc9.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Convert a georeferenced raster from ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"KOp6f1QGSP"},{"type":"strong","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Beijing 1954","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"urTHq8dXTn"}],"key":"ZgHmTQfk95"},{"type":"text","value":" (aka ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"HGDYWflWqs"},{"type":"emphasis","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Beijing 54","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"Nvm928A6TP"}],"key":"iu0XgceXy6"},{"type":"text","value":") to ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"n04ZRnzmpz"},{"type":"strong","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"WGS 84","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"LHwjAnjaqb"}],"key":"Awc68lsdCi"},{"type":"text","value":" using a table of ground-control points.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"ZCdDoGJ8uF"}],"key":"dXgiy0GPp6"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"strong","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Workflow","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"zB0hdu5XQf"}],"key":"COOhgcMxOv"}],"key":"FVtqVANvvL"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Load control-point table (","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"j9ZK3sPOqL"},{"type":"inlineCode","value":"54_to_84.csv","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Pe8kmMlfKP"},{"type":"text","value":").","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"EdgVDBijs2"}],"key":"Wc8nbYuZWf"}],"key":"NQEnIDZOxg"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Attach the GCPs (Beijing 54 ➜ WGS 84) to the original TIFF.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"IiHhye8RiN"}],"key":"r646mi10zB"}],"key":"GeVD4JCuUI"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Call ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"fQLIEMwaQz"},{"type":"strong","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"GDAL Warp","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"NmjfS27qUw"}],"key":"WP4u06f8Qi"},{"type":"text","value":" (","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"bugkahQEuD"},{"type":"inlineCode","value":"gdal.Warp","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"EX1ilMa0X0"},{"type":"text","value":") with a Thin-Plate Spline (TPS) or 1st-order polynomial transform.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Q38PzAR3Nf"}],"key":"O83wM5QCXC"}],"key":"rt0Hb3UrCA"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Save the re-projected raster as GeoTIFF in WGS 84.","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"yvOKKKwzK5"}],"key":"EMMxVv06Da"}],"key":"XnDnO97fgS"}],"key":"QEgR9N9gUF"}],"key":"wWxOP3vbEO"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Requirements","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"a1oznuA07K"}],"identifier":"requirements","label":"Requirements","html_id":"requirements","implicit":true,"key":"zcLTd2YnRe"},{"type":"code","lang":"bash","value":"conda install -c conda-forge gdal rasterio pyproj pandas","position":{"start":{"line":2,"column":1},"end":{"line":4,"column":1}},"key":"vCppxCROQw"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"GDAL ≥ 3.1 is recommended so that ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"FNNk6aDgzv"},{"type":"inlineCode","value":"gdal.Warp","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"PVJRrWKFaA"},{"type":"text","value":" can use the ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"UVSYkXUYyP"},{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"inlineCode","value":"tps=True","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"f0OILeYygV"}],"key":"YMIDmifYOr"},{"type":"text","value":" option.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"ULI0eilYiW"}],"key":"awrhxsBfPI"}],"key":"noetIb58ES"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nfrom osgeo import gdal, osr\nimport pandas as pd\nfrom typing import List\n","key":"I5ofqBbIt7"},{"type":"output","id":"4LmZWURlAyUdhTBVERaGz","data":[],"key":"yWN0tXisaD"}],"key":"uzEsImg17K"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# ---- User inputs -------------------------------------------------------\ninput_tiff   = \"beijing54.tif\"         # Source raster (Beijing 54)\ngcps_csv     = \"54_to_84.csv\"          # Control-point table (CSV)\noutput_tiff  = \"beijing54_to_wgs84.tif\"\n\n# Transform method:  'tps' (thin-plate spline) or polynomial order (int)\ntransform_method = \"tps\"   # choose \"tps\" or 1/2/3 for polynomial order\n","key":"fEYLO8Nn2F"},{"type":"output","id":"Tlcz_te5e153If0n2Qlx3","data":[],"key":"SuaAmZHnCj"}],"key":"Ef4zkQseZA"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# The CSV must contain:\n#   x54, y54  ▶ coordinates in Beijing 54 (same units as the raster)\n#   lon84, lat84 ▶ WGS 84 geographic coordinates (decimal degrees)\ngdf = pd.read_csv(gcps_csv)\n\n# Open source raster\nsrc_ds = gdal.Open(input_tiff, gdal.GA_ReadOnly)\nif src_ds is None:\n    raise FileNotFoundError(f\"Cannot open {input_tiff}\")\n\ngt = src_ds.GetGeoTransform()\ninv_gt = gdal.InvGeoTransform(gt)\n\n# Build GCP list\ngdal_gcps: List[gdal.GCP] = []\nfor _, row in gdf.iterrows():\n    x54, y54 = float(row['x54']), float(row['y54'])\n    lon84, lat84 = float(row['lon84']), float(row['lat84'])\n    # Convert world → pixel\n    px, py = gdal.ApplyGeoTransform(inv_gt, x54, y54)\n    gcp = gdal.GCP(lon84, lat84, 0, px, py)  # (lon, lat, z, pixel, line)\n    gdal_gcps.append(gcp)\n\nprint(f\"Loaded {len(gdal_gcps)} control points.\")\n","key":"iIuMr3MNB0"},{"type":"output","id":"Fozd7WMD4hTZmSS9HL7Ju","data":[],"key":"FCPIqcEbNU"}],"key":"OJ8MobgwCs"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Create an in-memory VRT copy with GCPs\nvrt_path = \"/vsimem/tmp_with_gcps.vrt\"\ngdal.Translate(\n    vrt_path,\n    src_ds,\n    GCPs=gdal_gcps,\n    outputSRS=\"EPSG:4326\"  # Target GCP spatial ref (WGS 84)\n)\nsrc_ds = None  # close\n","key":"TK2yduIugU"},{"type":"output","id":"3rknhndSoiIM3B1cu-1Pu","data":[],"key":"yYa6plTnFw"}],"key":"mWxdvQZI7v"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"warp_kwargs = dict(\n    dstSRS=\"EPSG:4326\",\n    format=\"GTiff\",\n    xRes=0.0002695,   # ≈ 30 m at the equator — adjust as needed\n    yRes=0.0002695,\n    resampleAlg=\"bilinear\",\n    multithread=True\n)\n\nif transform_method == \"tps\":\n    warp_kwargs[\"tps\"] = True\nelse:\n    warp_kwargs[\"polynomialOrder\"] = int(transform_method)\n\ngdal.Warp(\n    destNameOrDestDS=output_tiff,\n    srcDSOrSrcDSTab=vrt_path,\n    **warp_kwargs\n)\n\nprint(f\"Warp complete ➜ {output_tiff}\")\n","key":"kM2iOznCKO"},{"type":"output","id":"9ERZbOuUkJAxuOgbSYHU-","data":[],"key":"cNrxU53rrT"}],"key":"yAk3MevyhY"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds = gdal.Open(output_tiff)\nprint(\"Target CRS:\", ds.GetSpatialRef().ExportToWkt().split(',')[0])\nprint(\"Raster size :\", ds.RasterXSize, \"×\", ds.RasterYSize)\nprint(\"GeoTransform:\", ds.GetGeoTransform())\nds = None\n","key":"KHcoPjXLdh"},{"type":"output","id":"FUFK8a6nqjdcMQsnk9Adz","data":[],"key":"xd0B70Y88f"}],"key":"uK5RMYc0ac"},{"type":"block","kind":"notebook-content","children":[{"type":"thematicBreak","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tcYFVM0Ag4"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"strong","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Tips","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"QqnmeUENvv"}],"key":"et33Zs7c0A"}],"key":"F6RT843UGp"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":3,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"If you prefer to use a 1st-order polynomial instead of TPS, set ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"DXPPUr7VlP"},{"type":"inlineCode","value":"transform_method = 1","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"bX7GLGSrUO"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"TPxkS1JdNd"}],"key":"WKxpinJmaU"}],"key":"JxPnF2Melk"},{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Increase the number of well-distributed control points for higher accuracy.","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"l9xfunK2m1"}],"key":"vnAE98ijD9"}],"key":"zUcLODx1cr"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"xRes","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"vO0y9q4X7T"},{"type":"text","value":"/","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"pnDlzHyNJt"},{"type":"inlineCode","value":"yRes","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"l12RHzfl36"},{"type":"text","value":" control the output resolution. Adjust to suit your data.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"kuFcAqIasL"}],"key":"GWEo91xnps"}],"key":"jAGCFJ7HGH"}],"key":"e7mIRpfP91"}],"key":"G0zOcvKm2y"}],"key":"Vt1Eb3GYtN"},"references":{"cite":{"order":[],"data":{}}}}