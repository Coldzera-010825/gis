{"version":2,"kind":"Notebook","sha256":"3886337c7ae7976c812728c735fe26f95748d8df872517952c9177b5bbfae3e3","slug":"shp2tif-workflow","location":"/geoprocessing_code/geocode/shp2tif_workflow.ipynb","dependencies":[],"frontmatter":{"title":"Shapefile ➜ Float32 GeoTIFF (DEPTH2D) — Interactive + Batch","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"numbering":{"title":{"offset":2}},"exports":[{"format":"ipynb","filename":"shp2tif_workflow.ipynb","url":"/shp2tif_workflow-427d61e0f43f9e50c3c56d180b56e848.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"This notebook ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"kepBthRfnm"},{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"batch‑converts every ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"hGgRSQ25Xb"},{"type":"inlineCode","value":".shp","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Vq4pCyxBhg"},{"type":"text","value":" file beneath a chosen root directory into GeoTIFF rasters","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ebvvy2P1LF"}],"key":"vIvSROsONs"},{"type":"text","value":" while:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"qL1TOhZaDO"}],"key":"T9TbCc3wCb"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"repairing invalid geometries to avoid artefacts (e.g., stray horizontal lines);","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"u9YqcypUCw"}],"key":"qI3iuaCyuT"}],"key":"DMGHy0tN9P"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"ensuring the output raster is ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"PfAMxwjtoE"},{"type":"strong","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"≤ 4096 × 4096","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"QlZFT0anS3"}],"key":"N5QlEqL20X"},{"type":"text","value":" pixels (adjusting pixel size if necessary; default target ≈ ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"yBizbCVOI2"},{"type":"inlineCode","value":"0.00001","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"UXtmHhWIR1"},{"type":"text","value":" degree);","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"bcAkshSbOu"}],"key":"cc0OdeU0H4"}],"key":"J2vKIRmzGA"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"saving each GeoTIFF inside a sibling ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"kbTlshQPpn"},{"type":"inlineCode","value":"tif/","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"R1i5E5PIpU"},{"type":"text","value":" folder alongside its source shapefile;","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"TXY9jg7oJQ"}],"key":"QGKDlN7v7t"}],"key":"MdQe0nug9H"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"writing a quick‑look ","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"SAdDIxY7LN"},{"type":"emphasis","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"PNG","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"OHbqV6aFsY"}],"key":"sVI7LqlER7"},{"type":"text","value":" overlay (shapefile boundary + raster) for visual QA.","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"dAp0NUewGg"}],"key":"mGzwSkTPzI"}],"key":"ytpUhTQON1"},{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Interactive single‑file test","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"qvJPVui8aL"}],"key":"yDzCyE2X5h"},{"type":"text","value":" – preview one ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"mb8cK3P6BC"},{"type":"inlineCode","value":".shp","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"QobIOddrn9"},{"type":"text","value":" as a raster overlay without saving.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"CJzs8zqMWa"}],"key":"susjU1z5M1"}],"key":"lGYWIIeOnK"},{"type":"listItem","spread":true,"position":{"start":{"line":10,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"Batch conversion","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"cL5ZRhAjAk"}],"key":"SzByH4mWfz"},{"type":"text","value":" – scan timestamp‑named folders, convert each contained shapefile to 32‑bit float GeoTIFF (","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"m2JD60YC0k"},{"type":"inlineCode","value":"DEPTH2D","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"XipNvyQ6De"},{"type":"text","value":" band) named ","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"cNohXN9zDL"},{"type":"inlineCode","value":"<timestamp>_<frame>.tif","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"kDWQfXN00w"},{"type":"text","value":".","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"l936esXH1l"}],"key":"Mc0vrFdfhL"}],"key":"Bunmd3l27L"}],"key":"fAEtxDepyo"},{"type":"blockquote","position":{"start":{"line":12,"column":1},"end":{"line":22,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"strong","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"Dependencies","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"AdDMxbTY9j"}],"key":"jOKtZ7QlnS"}],"key":"Vbt7os5MML"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":13,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"GeoPandas ≥ 0.14","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"xgpVtxMC4m"}],"key":"qiE539N7fP"}],"key":"WRVALACsL4"},{"type":"listItem","spread":true,"position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Shapely ≥ 2.0","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"OQzqn9zj8V"}],"key":"DHUyPq2CxZ"}],"key":"dCwHsoZZQl"},{"type":"listItem","spread":true,"position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Rasterio ≥ 1.3","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"zU8xATk7XF"}],"key":"Dq7So4nFjA"}],"key":"KATURA1nxn"},{"type":"listItem","spread":true,"position":{"start":{"line":16,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Matplotlib","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"eQLmvHQPfr"}],"key":"fwRV4fSERL"}],"key":"WklWzSvaQk"}],"key":"IosYdt7iuU"},{"type":"paragraph","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"text","value":"Install (conda):","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"fNb6y4Sy26"}],"key":"VBSyyt5oXA"},{"type":"code","lang":"bash","value":"conda create -n gis python=3.11 geopandas rasterio matplotlib -c conda-forge\nconda activate gis","position":{"start":{"line":19,"column":1},"end":{"line":22,"column":1}},"key":"nAFU9oaszP"}],"key":"cBItbqxzco"},{"type":"paragraph","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"text","value":"All outputs limited to ≤ 4096×4096 pixels; overlapping polygons merged with ","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"CDLfK7rVih"},{"type":"emphasis","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"text","value":"max","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"ROMgRjq1y2"}],"key":"QwxliW1xur"},{"type":"text","value":" DEPTH2D; ","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"xkVZ0wGppJ"},{"type":"inlineCode","value":"nodata=-9999","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"DnKu6fc4wR"},{"type":"text","value":".","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"rEP8SX6PpL"}],"key":"NWyE1TFzRZ"}],"key":"W8Lzc3S5dC"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import warnings, math\nfrom pathlib import Path\nimport geopandas as gpd\nfrom shapely import make_valid\nimport rasterio\nfrom rasterio.transform import from_origin\nfrom rasterio.features import rasterize\nfrom rasterio.enums import MergeAlg\nimport matplotlib.pyplot as plt\n","key":"IpVDz2uFiB"},{"type":"output","id":"TSC0SB_pogytuLDYEoygA","data":[],"key":"JsasV9lwBa"}],"key":"mFeXSJ4DDm"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Configure I/O Paths","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Pyp8Zyyfeg"}],"identifier":"configure-i-o-paths","label":"Configure I/O Paths","html_id":"configure-i-o-paths","implicit":true,"key":"KD7U4HjLlr"}],"key":"FBiiMZgErT"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# SINGLE TEST\ntest_shp = Path(r'D:/gis/single_test/one.shp')   # change\n\n# BATCH\nbatch_root   = Path(r'D:/gis/batch_root')        # each sub‑folder = timestamp\nbatch_output = Path(r'D:/gis/tif_output')\nbatch_output.mkdir(parents=True, exist_ok=True)\n\nprint('Batch root :', batch_root.resolve())\nprint('Output root:', batch_output.resolve())\n","key":"RtMX1mXYq5"},{"type":"output","id":"ug7MLcV9NqpOm5Xb0sxBM","data":[],"key":"CImvSC5HBK"}],"key":"K5h13BjdsZ"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Parameters","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kvjFvudMm6"}],"identifier":"parameters","label":"Parameters","html_id":"parameters","implicit":true,"key":"lMnG3VEUPj"}],"key":"ZU4m91tSQd"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"PIXEL_LIMIT     = 4096\nPIXEL_SIZE_FINE = 1e-5    # deg pls defined by yourself\nNODATA          = -9999.0\n#MERGE_STRATEGY  = 'max'   # max/min/first\nFRAME_FIELD     = 'FRAME' # attribute for frame number\n","key":"rxUtslmmQ5"},{"type":"output","id":"SxY9HgU8dQe0xnO_TEw5x","data":[],"key":"fH8Mr0IoaC"}],"key":"qPoQabXtq5"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Utilities","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"a2XoZoAiA9"}],"identifier":"utilities","label":"Utilities","html_id":"utilities","implicit":true,"key":"D05bQ3rMZQ"}],"key":"ic2DCeIE5J"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def repair(gdf):\n    def _f(geom):\n        if geom is None or geom.is_empty:\n            return None\n        if not geom.is_valid:\n            try:\n                return make_valid(geom)\n            except Exception:\n                return geom.buffer(0)\n        return geom\n    gdf['geometry'] = gdf.geometry.apply(_f)\n    return gdf[~gdf.geometry.is_empty & gdf.geometry.notnull()]\n\ndef choose_px(bounds):\n    minx, miny, maxx, maxy = bounds\n    dx, dy = maxx - minx, maxy - miny\n    if dx/PIXEL_SIZE_FINE <= PIXEL_LIMIT and dy/PIXEL_SIZE_FINE <= PIXEL_LIMIT:\n        return PIXEL_SIZE_FINE\n    px = max(dx, dy)/PIXEL_LIMIT\n    if px > PIXEL_SIZE_FINE:\n        warnings.warn(f'Pixel size relaxed to {px:.6f}')\n    return px\n\ndef rasterize_depth(gdf):\n    minx, miny, maxx, maxy = gdf.total_bounds\n    px = choose_px((minx, miny, maxx, maxy))\n    width  = math.ceil((maxx - minx)/px)\n    height = math.ceil((maxy - miny)/px)\n    transform = from_origin(minx, maxy, px, px)\n\n    shapes = ((row.geometry, float(row['DEPTH2D'])) for _, row in gdf.iterrows())\n    arr = rasterize(shapes, out_shape=(height, width),\n                    fill=NODATA, dtype='float32',\n                    transform=transform)\n    return arr, transform\n","key":"IQReoYqjvp"},{"type":"output","id":"U3OYViaodq_2cd8eLY4fn","data":[],"key":"bG2XeToNBa"}],"key":"A2FimQiViW"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"1  Interactive Preview","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DQ7aEfQsgk"}],"identifier":"id-1-interactive-preview","label":"1  Interactive Preview","html_id":"id-1-interactive-preview","implicit":true,"key":"WtStVXS7uQ"}],"key":"fhamIK4OGR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"if test_shp.exists():\n    gdf = gpd.read_file(test_shp)\n    if 'DEPTH2D' not in gdf.columns:\n        raise KeyError('DEPTH2D missing')\n    gdf = repair(gdf)\n    arr, transform = rasterize_depth(gdf)\n\n    minx, miny, maxx, maxy = gdf.total_bounds\n    fig, ax = plt.subplots(figsize=(6,6))\n    im = ax.imshow(arr, extent=[minx,maxx,miny,maxy], origin='upper', cmap='viridis', alpha=0.6)\n    gdf.boundary.plot(ax=ax, edgecolor='white', linewidth=0.4)\n    plt.colorbar(im, ax=ax, fraction=0.022, pad=0.01, label='DEPTH2D')\n    ax.set_axis_off()\n    plt.show()\nelse:\n    print('Set `test_shp` path to an existing shapefile for preview.')\n","key":"lBGS5VUuQT"},{"type":"output","id":"_mqZ9jpYcYaYeL2UTxgCc","data":[],"key":"QMbNQE5DIl"}],"key":"pysGoUZtou"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"2  Batch Conversion","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sUwHntN0eT"}],"identifier":"id-2-batch-conversion","label":"2  Batch Conversion","html_id":"id-2-batch-conversion","implicit":true,"key":"ZRp3bZRvAA"}],"key":"huSgGqsEZ8"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"folders = [p for p in batch_root.iterdir() if p.is_dir()]\nprint(f'Folders found: {len(folders)}')\n\nfor ts_dir in folders:\n    timestamp = ts_dir.name\n    shp_paths = list(ts_dir.glob('*.shp'))\n    if not shp_paths:\n        print(f'[SKIP] {timestamp}: no shp')\n        continue\n    shp_path = shp_paths[0]\n\n    try:\n        gdf = gpd.read_file(shp_path)\n        if 'DEPTH2D' not in gdf.columns:\n            print(f'[SKIP] {shp_path.name}: DEPTH2D missing')\n            continue\n        gdf = repair(gdf)\n        frame_val = (str(gdf[FRAME_FIELD].dropna().iloc[0])\n                     if FRAME_FIELD in gdf.columns and not gdf[FRAME_FIELD].dropna().empty\n                     else shp_path.stem)\n        arr, transform = rasterize_depth(gdf)\n        out_tif = batch_output / f'{timestamp}_{frame_val}.tif'\n\n        meta = dict(driver='GTiff',\n                    height=arr.shape[0], width=arr.shape[1],\n                    count=1, dtype='float32', transform=transform,\n                    crs=gdf.crs, nodata=NODATA)\n\n        with rasterio.open(out_tif, 'w', **meta) as dst:\n            dst.write(arr, 1)\n\n        print(f'[OK] {timestamp}/{shp_path.name} → {out_tif.name}')\n    except Exception as e:\n        print(f'[ERR] {shp_path}: {e}')\n","key":"sJm6wyculp"},{"type":"output","id":"FvNnFeH4_tYM25GDsxAzc","data":[],"key":"jGMBy8lp0v"}],"key":"pjUE0UnBPK"}],"key":"Ymbr2y1QjS"},"references":{"cite":{"order":[],"data":{}}}}