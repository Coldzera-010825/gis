{"version":2,"kind":"Notebook","sha256":"9744902e8e0e8e7c752f31f2f2153314f780528165a06b788ddc9af48a18614d","slug":"beijing54-to-wgs84","location":"/geocode/beijing54_to_wgs84.ipynb","dependencies":[],"frontmatter":{"title":"Beijing 1954 (TIFF) ➜ WGS 84 (EPSG:4326) — Raster Re-projection","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3","language":"python"},"numbering":{"title":{"offset":1}},"exports":[{"format":"ipynb","filename":"beijing54_to_wgs84.ipynb","url":"/beijing54_to_wgs84-ca55633da1eb884d123f11ab84a8b043.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Convert a georeferenced raster from ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"iFeC7Ao0KT"},{"type":"strong","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Beijing 1954","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"BFHxPXqk2r"}],"key":"DSWOvIWlIt"},{"type":"text","value":" (aka ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"wyrBcjzjMx"},{"type":"emphasis","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Beijing 54","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"TakUEBE98B"}],"key":"jPqLDtfypu"},{"type":"text","value":") to ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"uuwcy5Vv0k"},{"type":"strong","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"WGS 84","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"dphrjnG43Y"}],"key":"rGTIt4wkIT"},{"type":"text","value":" using a table of ground-control points.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"ckYFySoTUz"}],"key":"AwAgdOODod"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"strong","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Workflow","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"gPRfHuvEvU"}],"key":"hWuzS3bSc6"}],"key":"dsAF7Pp8qh"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Load control-point table (","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"sh0RptgDRn"},{"type":"inlineCode","value":"54_to_84.csv","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"eD3BzAyieh"},{"type":"text","value":").","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"lgDvL77Lja"}],"key":"ajChds8inT"}],"key":"PiRxAFGiLO"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Attach the GCPs (Beijing 54 ➜ WGS 84) to the original TIFF.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"mbyGkl4yIY"}],"key":"qtPLfKQX9D"}],"key":"gvf9P9c8PA"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Call ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"ESeC2fdUie"},{"type":"strong","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"GDAL Warp","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"A14WDrVpgJ"}],"key":"PQtg5C5cnU"},{"type":"text","value":" (","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"X1aMz6SUgP"},{"type":"inlineCode","value":"gdal.Warp","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"eu6gI1pMVW"},{"type":"text","value":") with a Thin-Plate Spline (TPS) or 1st-order polynomial transform.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"vFzZPKM78D"}],"key":"fvDL4HoE10"}],"key":"LljIXKNBcQ"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Save the re-projected raster as GeoTIFF in WGS 84.","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"oIijX4LGyJ"}],"key":"zNH7I1Ekqx"}],"key":"gdj5OBHhPu"}],"key":"IZzF6UAS6w"}],"key":"r4kdjVdZhq"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Requirements","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FbkYKjNykF"}],"identifier":"requirements","label":"Requirements","html_id":"requirements","implicit":true,"key":"wmUqFZvbnV"},{"type":"code","lang":"bash","value":"conda install -c conda-forge gdal rasterio pyproj pandas","position":{"start":{"line":2,"column":1},"end":{"line":4,"column":1}},"key":"ITMUXYtfUy"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"GDAL ≥ 3.1 is recommended so that ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"shYGRXFQzp"},{"type":"inlineCode","value":"gdal.Warp","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"PwMdxUQlBK"},{"type":"text","value":" can use the ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"T8HP3iZKcO"},{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"inlineCode","value":"tps=True","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"yZ3lHAfkzB"}],"key":"kEd6FQU3gF"},{"type":"text","value":" option.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"QtQqhgLzJA"}],"key":"eU5WuynR2Q"}],"key":"cPfUU6TsWd"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nfrom osgeo import gdal, osr\nimport pandas as pd\nfrom typing import List\n","key":"EwSczBFMpQ"},{"type":"output","id":"P0TYOvHV-Ur5kU3oVLSph","data":[],"key":"nEZGBIPfbk"}],"key":"sLsymFABBb"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# ---- User inputs -------------------------------------------------------\ninput_tiff   = \"beijing54.tif\"         # Source raster (Beijing 54)\ngcps_csv     = \"54_to_84.csv\"          # Control-point table (CSV)\noutput_tiff  = \"beijing54_to_wgs84.tif\"\n\n# Transform method:  'tps' (thin-plate spline) or polynomial order (int)\ntransform_method = \"tps\"   # choose \"tps\" or 1/2/3 for polynomial order\n","key":"OVLbMucvu1"},{"type":"output","id":"Zzu9N7URq4U9NRCfqkLra","data":[],"key":"fe25Mu1iXN"}],"key":"GisDQzky7W"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# The CSV must contain:\n#   x54, y54  ▶ coordinates in Beijing 54 (same units as the raster)\n#   lon84, lat84 ▶ WGS 84 geographic coordinates (decimal degrees)\ngdf = pd.read_csv(gcps_csv)\n\n# Open source raster\nsrc_ds = gdal.Open(input_tiff, gdal.GA_ReadOnly)\nif src_ds is None:\n    raise FileNotFoundError(f\"Cannot open {input_tiff}\")\n\ngt = src_ds.GetGeoTransform()\ninv_gt = gdal.InvGeoTransform(gt)\n\n# Build GCP list\ngdal_gcps: List[gdal.GCP] = []\nfor _, row in gdf.iterrows():\n    x54, y54 = float(row['x54']), float(row['y54'])\n    lon84, lat84 = float(row['lon84']), float(row['lat84'])\n    # Convert world → pixel\n    px, py = gdal.ApplyGeoTransform(inv_gt, x54, y54)\n    gcp = gdal.GCP(lon84, lat84, 0, px, py)  # (lon, lat, z, pixel, line)\n    gdal_gcps.append(gcp)\n\nprint(f\"Loaded {len(gdal_gcps)} control points.\")\n","key":"pM3POHGv6h"},{"type":"output","id":"Z5fohhsqNAU_xh_JOBFmS","data":[],"key":"th91Bjpatk"}],"key":"jvZEMlVaE8"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Create an in-memory VRT copy with GCPs\nvrt_path = \"/vsimem/tmp_with_gcps.vrt\"\ngdal.Translate(\n    vrt_path,\n    src_ds,\n    GCPs=gdal_gcps,\n    outputSRS=\"EPSG:4326\"  # Target GCP spatial ref (WGS 84)\n)\nsrc_ds = None  # close\n","key":"k40p4UAQ6q"},{"type":"output","id":"vd2bXSf91dnAXiGatkqm2","data":[],"key":"Tj6MWltptH"}],"key":"ZtpbFZ1BOy"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"warp_kwargs = dict(\n    dstSRS=\"EPSG:4326\",\n    format=\"GTiff\",\n    xRes=0.0002695,   # ≈ 30 m at the equator — adjust as needed\n    yRes=0.0002695,\n    resampleAlg=\"bilinear\",\n    multithread=True\n)\n\nif transform_method == \"tps\":\n    warp_kwargs[\"tps\"] = True\nelse:\n    warp_kwargs[\"polynomialOrder\"] = int(transform_method)\n\ngdal.Warp(\n    destNameOrDestDS=output_tiff,\n    srcDSOrSrcDSTab=vrt_path,\n    **warp_kwargs\n)\n\nprint(f\"Warp complete ➜ {output_tiff}\")\n","key":"ORkCv0pvZl"},{"type":"output","id":"EB4vz4zRexPx282HqBsCO","data":[],"key":"DuKBZkYeit"}],"key":"i5Gpkjezxd"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds = gdal.Open(output_tiff)\nprint(\"Target CRS:\", ds.GetSpatialRef().ExportToWkt().split(',')[0])\nprint(\"Raster size :\", ds.RasterXSize, \"×\", ds.RasterYSize)\nprint(\"GeoTransform:\", ds.GetGeoTransform())\nds = None\n","key":"Bgrpgd8LLS"},{"type":"output","id":"Zm7XlbyldkCXxL6PhdcUu","data":[],"key":"RjIAmdFGa4"}],"key":"HuUwwV58CD"},{"type":"block","kind":"notebook-content","children":[{"type":"thematicBreak","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Fwz9oIBes6"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"strong","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Tips","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"sLLz7mIGh0"}],"key":"pBjN6ta6hE"}],"key":"nF2Of8aGLP"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":3,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"If you prefer to use a 1st-order polynomial instead of TPS, set ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"WZekuuZqrD"},{"type":"inlineCode","value":"transform_method = 1","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"lLRXrqgFr5"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"eLurO7dSob"}],"key":"Q6iqYP0P9h"}],"key":"NdlUZDK9sR"},{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Increase the number of well-distributed control points for higher accuracy.","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"lzofUH3XxV"}],"key":"GOQAxaIsdj"}],"key":"L3dw7t4F3G"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"xRes","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"aVbLXwyWUh"},{"type":"text","value":"/","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"P80T7Ir1bT"},{"type":"inlineCode","value":"yRes","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"ReEWAUrrcy"},{"type":"text","value":" control the output resolution. Adjust to suit your data.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"VS4j6NkLWu"}],"key":"ELf8s2Kl7P"}],"key":"aFNhNGsksg"}],"key":"zljlGDUwML"}],"key":"RaY4nl395D"}],"key":"RkKhfKb2Bj"},"references":{"cite":{"order":[],"data":{}}}}