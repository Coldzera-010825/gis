{"version":2,"kind":"Notebook","sha256":"9744902e8e0e8e7c752f31f2f2153314f780528165a06b788ddc9af48a18614d","slug":"beijing54-to-wgs84","location":"/geocode/beijing54_to_wgs84.ipynb","dependencies":[],"frontmatter":{"title":"Beijing 1954 (TIFF) ➜ WGS 84 (EPSG:4326) — Raster Re-projection","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3","language":"python"},"numbering":{"title":{"offset":1}},"exports":[{"format":"ipynb","filename":"beijing54_to_wgs84.ipynb","url":"/beijing54_to_wgs84-ca55633da1eb884d123f11ab84a8b043.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Convert a georeferenced raster from ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"hNVS0U7IRb"},{"type":"strong","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Beijing 1954","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"tSYyll45FK"}],"key":"oBRgfPQ1cx"},{"type":"text","value":" (aka ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"lTH13yIUrJ"},{"type":"emphasis","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Beijing 54","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"t3heUVu6Nm"}],"key":"v1klD9TG69"},{"type":"text","value":") to ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"TAnBvJV5z0"},{"type":"strong","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"WGS 84","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"tIUNVrD8Cg"}],"key":"knwWoA5wlw"},{"type":"text","value":" using a table of ground-control points.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"oAqmGNSgEU"}],"key":"L44UUoYC8i"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"strong","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Workflow","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"m8fHB8l4TW"}],"key":"epXxr10KEn"}],"key":"plKc9xUaax"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Load control-point table (","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"FgZYdRdVZG"},{"type":"inlineCode","value":"54_to_84.csv","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"qH5xhKOXEK"},{"type":"text","value":").","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"wi2fEY7NRF"}],"key":"iU9fGT25vh"}],"key":"U1LOWcPPkF"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Attach the GCPs (Beijing 54 ➜ WGS 84) to the original TIFF.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"l764bmBtR0"}],"key":"TRbRQmZgWJ"}],"key":"myH6377upK"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Call ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"MvgqHM2gUC"},{"type":"strong","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"GDAL Warp","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Yws73V3V71"}],"key":"ZNLV8GpOIv"},{"type":"text","value":" (","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"qnPXvHEhGF"},{"type":"inlineCode","value":"gdal.Warp","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Oeq21kEB6D"},{"type":"text","value":") with a Thin-Plate Spline (TPS) or 1st-order polynomial transform.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"mKT4LSuW0m"}],"key":"UTam4trnhu"}],"key":"DuNkqWajfo"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Save the re-projected raster as GeoTIFF in WGS 84.","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"HWRQ23OHZy"}],"key":"W1qQ0GRGAD"}],"key":"ISsuBJQdzN"}],"key":"WxohSSF1dV"}],"key":"agMoZE8cM3"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Requirements","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"C8C7YnJLYI"}],"identifier":"requirements","label":"Requirements","html_id":"requirements","implicit":true,"key":"MzIaO7j0ty"},{"type":"code","lang":"bash","value":"conda install -c conda-forge gdal rasterio pyproj pandas","position":{"start":{"line":2,"column":1},"end":{"line":4,"column":1}},"key":"t97hyJaAG8"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"GDAL ≥ 3.1 is recommended so that ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"gOVugOlt5V"},{"type":"inlineCode","value":"gdal.Warp","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"i0sMbqBePD"},{"type":"text","value":" can use the ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"exlIhdCLqn"},{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"inlineCode","value":"tps=True","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"WuMabf276r"}],"key":"MTyxbiEjKD"},{"type":"text","value":" option.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"s3v99yfAon"}],"key":"Tro4csWtnc"}],"key":"M0qEAaV8P1"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nfrom osgeo import gdal, osr\nimport pandas as pd\nfrom typing import List\n","key":"oySAyLP6dp"},{"type":"output","id":"P0TYOvHV-Ur5kU3oVLSph","data":[],"key":"r8YDUJaUnG"}],"key":"oEylZHxqvG"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# ---- User inputs -------------------------------------------------------\ninput_tiff   = \"beijing54.tif\"         # Source raster (Beijing 54)\ngcps_csv     = \"54_to_84.csv\"          # Control-point table (CSV)\noutput_tiff  = \"beijing54_to_wgs84.tif\"\n\n# Transform method:  'tps' (thin-plate spline) or polynomial order (int)\ntransform_method = \"tps\"   # choose \"tps\" or 1/2/3 for polynomial order\n","key":"PUdpzSfqS9"},{"type":"output","id":"Zzu9N7URq4U9NRCfqkLra","data":[],"key":"QE8ixRFEtE"}],"key":"JklbHu70XM"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# The CSV must contain:\n#   x54, y54  ▶ coordinates in Beijing 54 (same units as the raster)\n#   lon84, lat84 ▶ WGS 84 geographic coordinates (decimal degrees)\ngdf = pd.read_csv(gcps_csv)\n\n# Open source raster\nsrc_ds = gdal.Open(input_tiff, gdal.GA_ReadOnly)\nif src_ds is None:\n    raise FileNotFoundError(f\"Cannot open {input_tiff}\")\n\ngt = src_ds.GetGeoTransform()\ninv_gt = gdal.InvGeoTransform(gt)\n\n# Build GCP list\ngdal_gcps: List[gdal.GCP] = []\nfor _, row in gdf.iterrows():\n    x54, y54 = float(row['x54']), float(row['y54'])\n    lon84, lat84 = float(row['lon84']), float(row['lat84'])\n    # Convert world → pixel\n    px, py = gdal.ApplyGeoTransform(inv_gt, x54, y54)\n    gcp = gdal.GCP(lon84, lat84, 0, px, py)  # (lon, lat, z, pixel, line)\n    gdal_gcps.append(gcp)\n\nprint(f\"Loaded {len(gdal_gcps)} control points.\")\n","key":"kQ8Bbe6mGG"},{"type":"output","id":"Z5fohhsqNAU_xh_JOBFmS","data":[],"key":"CidlMQwS2K"}],"key":"xd0hLnwPPn"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Create an in-memory VRT copy with GCPs\nvrt_path = \"/vsimem/tmp_with_gcps.vrt\"\ngdal.Translate(\n    vrt_path,\n    src_ds,\n    GCPs=gdal_gcps,\n    outputSRS=\"EPSG:4326\"  # Target GCP spatial ref (WGS 84)\n)\nsrc_ds = None  # close\n","key":"YCIs0VHrta"},{"type":"output","id":"vd2bXSf91dnAXiGatkqm2","data":[],"key":"tJzfXxfb8K"}],"key":"h1KrvlOrLy"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"warp_kwargs = dict(\n    dstSRS=\"EPSG:4326\",\n    format=\"GTiff\",\n    xRes=0.0002695,   # ≈ 30 m at the equator — adjust as needed\n    yRes=0.0002695,\n    resampleAlg=\"bilinear\",\n    multithread=True\n)\n\nif transform_method == \"tps\":\n    warp_kwargs[\"tps\"] = True\nelse:\n    warp_kwargs[\"polynomialOrder\"] = int(transform_method)\n\ngdal.Warp(\n    destNameOrDestDS=output_tiff,\n    srcDSOrSrcDSTab=vrt_path,\n    **warp_kwargs\n)\n\nprint(f\"Warp complete ➜ {output_tiff}\")\n","key":"bJx2opnHK4"},{"type":"output","id":"EB4vz4zRexPx282HqBsCO","data":[],"key":"IwQU0WXBcT"}],"key":"dzlRL57tTl"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds = gdal.Open(output_tiff)\nprint(\"Target CRS:\", ds.GetSpatialRef().ExportToWkt().split(',')[0])\nprint(\"Raster size :\", ds.RasterXSize, \"×\", ds.RasterYSize)\nprint(\"GeoTransform:\", ds.GetGeoTransform())\nds = None\n","key":"WVvJk9gkR1"},{"type":"output","id":"Zm7XlbyldkCXxL6PhdcUu","data":[],"key":"zYMR2fCk6v"}],"key":"J7uzrV1tEi"},{"type":"block","kind":"notebook-content","children":[{"type":"thematicBreak","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"y9QOa7UpxY"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"strong","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Tips","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"lQzkGFxps3"}],"key":"OuDxd4Fyyj"}],"key":"j94JuK0IRS"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":3,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"If you prefer to use a 1st-order polynomial instead of TPS, set ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"jiVjvzlqWj"},{"type":"inlineCode","value":"transform_method = 1","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"qsHabUqyGh"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"DgCabUn1CY"}],"key":"AfPutKo9Cb"}],"key":"ArM3lzSWbl"},{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Increase the number of well-distributed control points for higher accuracy.","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"fHUIOg8bkP"}],"key":"pn0Sq5aTUk"}],"key":"UDSgYYB6Vs"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"xRes","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"MG4U24t509"},{"type":"text","value":"/","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"ht7aE1oy57"},{"type":"inlineCode","value":"yRes","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"uPlzLh73Zr"},{"type":"text","value":" control the output resolution. Adjust to suit your data.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"M28z4l9GSH"}],"key":"D315WZ08bO"}],"key":"mbEHhEQkrF"}],"key":"aXl6fUnuhZ"}],"key":"AksDKypGrb"}],"key":"I89AAorioY"},"references":{"cite":{"order":[],"data":{}}}}