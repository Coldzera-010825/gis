{"version":2,"kind":"Notebook","sha256":"9744902e8e0e8e7c752f31f2f2153314f780528165a06b788ddc9af48a18614d","slug":"beijing54-to-wgs84","location":"/geoprocessing_code/geocode/beijing54_to_wgs84.ipynb","dependencies":[],"frontmatter":{"title":"Beijing 1954 (TIFF) ➜ WGS 84 (EPSG:4326) — Raster Re-projection","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3","language":"python"},"numbering":{"title":{"offset":2}},"exports":[{"format":"ipynb","filename":"beijing54_to_wgs84.ipynb","url":"/beijing54_to_wgs84-9fff8be8073378d3ad9581628868bbc9.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Convert a georeferenced raster from ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"Q5WTE1KEuU"},{"type":"strong","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Beijing 1954","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"H5b1l0T8Ik"}],"key":"n0MFZBHkvA"},{"type":"text","value":" (aka ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"fkLbar2684"},{"type":"emphasis","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Beijing 54","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"IEmlAGDkdc"}],"key":"mcSZu8nzBe"},{"type":"text","value":") to ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"WzQftbUqfR"},{"type":"strong","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"WGS 84","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"JaWKg0rsAN"}],"key":"ZlXuiXfL1U"},{"type":"text","value":" using a table of ground-control points.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"A0MaZhER4p"}],"key":"qAhNjilGTA"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"strong","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Workflow","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"H39N8RbyN6"}],"key":"jQMTkK2cpl"}],"key":"BM5g5xbAIM"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Load control-point table (","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"QY44mb2t4L"},{"type":"inlineCode","value":"54_to_84.csv","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"L7EnbHOWgH"},{"type":"text","value":").","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"XuHH2tYrtM"}],"key":"csovToqyPp"}],"key":"va8tNOyKjH"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Attach the GCPs (Beijing 54 ➜ WGS 84) to the original TIFF.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"Z5RBCdMcAK"}],"key":"h7OIMbG0u6"}],"key":"IvzJSmNstX"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Call ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"bC99ot4XTg"},{"type":"strong","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"GDAL Warp","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"H5ggwnKg9M"}],"key":"qeibzgqXMK"},{"type":"text","value":" (","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"upsbhfjxot"},{"type":"inlineCode","value":"gdal.Warp","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"KYvFcMOzhN"},{"type":"text","value":") with a Thin-Plate Spline (TPS) or 1st-order polynomial transform.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"M2t2XCMipV"}],"key":"xAb6LNUngi"}],"key":"wyLOGimI9F"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Save the re-projected raster as GeoTIFF in WGS 84.","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"O6ZYapHJzY"}],"key":"zzsOSdRDzP"}],"key":"yKI4Szfl4x"}],"key":"OLul6MGnK4"}],"key":"YfO0NWO1P5"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Requirements","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dJ9YubBlnS"}],"identifier":"requirements","label":"Requirements","html_id":"requirements","implicit":true,"key":"PgiCse4m90"},{"type":"code","lang":"bash","value":"conda install -c conda-forge gdal rasterio pyproj pandas","position":{"start":{"line":2,"column":1},"end":{"line":4,"column":1}},"key":"FwymuKeGRD"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"GDAL ≥ 3.1 is recommended so that ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Ar8d21AikB"},{"type":"inlineCode","value":"gdal.Warp","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"irIbP3GFEl"},{"type":"text","value":" can use the ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"rcpcIwjLV0"},{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"inlineCode","value":"tps=True","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"zYSKn2XQxc"}],"key":"dssqnzbkiQ"},{"type":"text","value":" option.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"nyWvuEn5If"}],"key":"nQn8TczUTt"}],"key":"p0mhh9UEvR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nfrom osgeo import gdal, osr\nimport pandas as pd\nfrom typing import List\n","key":"u6IN5qUBIe"},{"type":"output","id":"Pza4RpK_6PU-3VEPDuoUE","data":[],"key":"baDermMOYA"}],"key":"qRh2zvNDME"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# ---- User inputs -------------------------------------------------------\ninput_tiff   = \"beijing54.tif\"         # Source raster (Beijing 54)\ngcps_csv     = \"54_to_84.csv\"          # Control-point table (CSV)\noutput_tiff  = \"beijing54_to_wgs84.tif\"\n\n# Transform method:  'tps' (thin-plate spline) or polynomial order (int)\ntransform_method = \"tps\"   # choose \"tps\" or 1/2/3 for polynomial order\n","key":"YY491Idvih"},{"type":"output","id":"pMKeeCuErHDco7IiX-oOA","data":[],"key":"iYiyNaLylU"}],"key":"Mc3DbAkmge"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# The CSV must contain:\n#   x54, y54  ▶ coordinates in Beijing 54 (same units as the raster)\n#   lon84, lat84 ▶ WGS 84 geographic coordinates (decimal degrees)\ngdf = pd.read_csv(gcps_csv)\n\n# Open source raster\nsrc_ds = gdal.Open(input_tiff, gdal.GA_ReadOnly)\nif src_ds is None:\n    raise FileNotFoundError(f\"Cannot open {input_tiff}\")\n\ngt = src_ds.GetGeoTransform()\ninv_gt = gdal.InvGeoTransform(gt)\n\n# Build GCP list\ngdal_gcps: List[gdal.GCP] = []\nfor _, row in gdf.iterrows():\n    x54, y54 = float(row['x54']), float(row['y54'])\n    lon84, lat84 = float(row['lon84']), float(row['lat84'])\n    # Convert world → pixel\n    px, py = gdal.ApplyGeoTransform(inv_gt, x54, y54)\n    gcp = gdal.GCP(lon84, lat84, 0, px, py)  # (lon, lat, z, pixel, line)\n    gdal_gcps.append(gcp)\n\nprint(f\"Loaded {len(gdal_gcps)} control points.\")\n","key":"r6xvjxHREa"},{"type":"output","id":"9zjJOboVoXtk57JmwS1Bs","data":[],"key":"yzEmkgPiDw"}],"key":"F4ieTdvxl1"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Create an in-memory VRT copy with GCPs\nvrt_path = \"/vsimem/tmp_with_gcps.vrt\"\ngdal.Translate(\n    vrt_path,\n    src_ds,\n    GCPs=gdal_gcps,\n    outputSRS=\"EPSG:4326\"  # Target GCP spatial ref (WGS 84)\n)\nsrc_ds = None  # close\n","key":"GCFVPeVl49"},{"type":"output","id":"DOBnWQjEeWQtfJ0xaL_e4","data":[],"key":"Lp8ar2qcJd"}],"key":"dNHAFqmH1w"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"warp_kwargs = dict(\n    dstSRS=\"EPSG:4326\",\n    format=\"GTiff\",\n    xRes=0.0002695,   # ≈ 30 m at the equator — adjust as needed\n    yRes=0.0002695,\n    resampleAlg=\"bilinear\",\n    multithread=True\n)\n\nif transform_method == \"tps\":\n    warp_kwargs[\"tps\"] = True\nelse:\n    warp_kwargs[\"polynomialOrder\"] = int(transform_method)\n\ngdal.Warp(\n    destNameOrDestDS=output_tiff,\n    srcDSOrSrcDSTab=vrt_path,\n    **warp_kwargs\n)\n\nprint(f\"Warp complete ➜ {output_tiff}\")\n","key":"g8mE6EzjnE"},{"type":"output","id":"Mq0AcTw11OeNpveHAt-kZ","data":[],"key":"BZQ7vAszBB"}],"key":"dyDu97izgY"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds = gdal.Open(output_tiff)\nprint(\"Target CRS:\", ds.GetSpatialRef().ExportToWkt().split(',')[0])\nprint(\"Raster size :\", ds.RasterXSize, \"×\", ds.RasterYSize)\nprint(\"GeoTransform:\", ds.GetGeoTransform())\nds = None\n","key":"qXqH2UCUg2"},{"type":"output","id":"hNQBgTZeEzce3M7-mLs79","data":[],"key":"Nx7aeQh8vG"}],"key":"surEAqJpmu"},{"type":"block","kind":"notebook-content","children":[{"type":"thematicBreak","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vpvU57x94f"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"strong","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Tips","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"FXA5lYklq8"}],"key":"gDbktEkYw2"}],"key":"NPWHlJaTjD"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":3,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"If you prefer to use a 1st-order polynomial instead of TPS, set ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"N1LAkYckqJ"},{"type":"inlineCode","value":"transform_method = 1","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"gLlXQgd6kB"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"fGPwvuLE8M"}],"key":"hK1npWUw0y"}],"key":"NQCzLbPkhc"},{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Increase the number of well-distributed control points for higher accuracy.","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"lPINy1b9jY"}],"key":"ElvbrFBWRc"}],"key":"jxxGyKsXNC"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"xRes","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"m7rCohkddu"},{"type":"text","value":"/","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"pGQvxYI1oe"},{"type":"inlineCode","value":"yRes","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Q1iafFFkZs"},{"type":"text","value":" control the output resolution. Adjust to suit your data.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"lvxyZExxof"}],"key":"vElWje441O"}],"key":"pmQaCixSJg"}],"key":"kMjIq1hInB"}],"key":"ScymIgOMRj"}],"key":"a2itPhu8Hd"},"references":{"cite":{"order":[],"data":{}}}}